services:
  pw:
    image: mcr.microsoft.com/playwright:v1.58.0-noble
    working_dir: /work
    init: true
    ipc: host
    shm_size: "1gb"
    environment:
      CI: "true"
      PLAYWRIGHT_BROWSERS_PATH: /ms-playwright
    volumes:
      - ./:/work
      - pw_node_modules:/work/node_modules
    command: ["bash", "/work/scripts/run-tests.sh"]

  pw_record:
    build:
      context: .
      dockerfile: Dockerfile.pw-vnc
    working_dir: /work
    init: true
    ipc: host
    shm_size: "1gb"
    env_file:
      - path: .env
        required: false
    environment:
      PLAYWRIGHT_BROWSERS_PATH: /ms-playwright
      TARGET_URL: ${TARGET_URL:-https://example.com}
      OUT_FILE: ${OUT_FILE:-tests/recorded.spec.js}
    ports:
      - "127.0.0.1:6080:6080"
    volumes:
      - ./:/work
      - pw_node_modules:/work/node_modules
    command: ["bash", "/work/scripts/start-recording.sh"]

volumes:
  pw_node_modules:
